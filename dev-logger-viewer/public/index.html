<!-- <!DOCTYPE html> -->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–‹ç™¼æ—¥èªŒæŸ¥çœ‹å™¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            padding-top: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }
        .conversation-list {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .conversation-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .conversation-item:hover {
            background-color: #f8f9fa;
        }
        .conversation-item.active {
            background-color: #e9ecef;
        }
        .badge-category {
            font-size: 0.8em;
        }
        .conversation-detail {
            max-height: calc(100vh - 130px);
            overflow-y: auto;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            max-width: 100%;
            overflow-x: auto;
        }
        code {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
        }
        .no-conversation-selected {
            display: flex;
            height: 100%;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
        .search-container {
            margin-bottom: 20px;
        }

        /* å°è©±æµæ¨£å¼ */
        .conversation-flow {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 10px 0;
            position: relative;
        }

        /* ç”¨æˆ¶å•é¡Œæ¨£å¼ */
        .user-query {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            max-width: 90%;
            align-self: flex-end;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* AIå›ç­”æ¨£å¼ */
        .ai-response {
            background-color: #f5f5f5;
            border-left: 4px solid #9e9e9e;
            border-radius: 8px;
            padding: 15px;
            max-width: 90%;
            align-self: flex-start;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* å°è©±é ­éƒ¨æ¨£å¼ */
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* å°è©±åºè™Ÿæ¨£å¼ */
        .message-number {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        /* ç”¨æˆ¶é ­åƒå’ŒAIé ­åƒ */
        .user-icon, .ai-icon {
            font-size: 14px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            color: white;
        }

        .user-icon {
            background-color: #2196f3;
        }

        .ai-icon {
            background-color: #9e9e9e;
        }

        /* å°è©±å…§å®¹æ¨£å¼ */
        .message-content {
            line-height: 1.5;
            overflow-wrap: break-word;
        }

        /* åæ‡‰æŒ‰éˆ• */
        .message-reactions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .reaction-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 0.9em;
            color: #757575;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .reaction-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Markdown å¢å¼· */
        .message-content ul, 
        .message-content ol {
            padding-left: 20px;
        }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content blockquote {
            border-left: 3px solid #e0e0e0;
            padding-left: 10px;
            margin-left: 0;
            color: #616161;
        }

        /* åœ¨ <style> å€å¡Šä¸­æ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹æ¨£å¼ */
body {
  background-color: #121212;
  color: #e0e0e0;
}

.card {
  background-color: #1e1e1e;
  border-color: #333;
}

.card-header {
  background-color: #252525;
  border-bottom-color: #333;
}

.list-group-item {
  background-color: #1e1e1e;
  border-color: #333;
  color: #e0e0e0;
}

.list-group-item:hover {
  background-color: #252525;
}

.list-group-item.active {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

.text-muted {
  color: #aaa !important;
}

.conversation-item:hover {
  background-color: #252525;
}

.user-query {
  background-color: #0d47a1;
  border-left: 4px solid #1976d2;
}

.ai-response {
  background-color: #2d2d2d;
  border-left: 4px solid #757575;
}

/* ä»£ç¢¼å€å¡Šæ¨£å¼ */
pre {
  background-color: #2d2d2d;
  color: #e0e0e0;
}

.message-number {
  background-color: rgba(255, 255, 255, 0.1);
}

/* é©é…é«˜äº®æ¨£å¼ */
.hljs {
  background-color: #2d2d2d;
}
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center mb-4">é–‹ç™¼æ—¥èªŒæŸ¥çœ‹å™¨</h1>
        
        <div class="row">
            <!-- å·¦å´é‚Šæ¬„ï¼šå°ˆæ¡ˆèˆ‡æœç´¢ -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        å°ˆæ¡ˆåˆ—è¡¨
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush" id="project-list">
                            <li class="list-group-item text-center">è¼‰å…¥ä¸­...</li>
                        </ul>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header bg-success text-white">
                        æœç´¢
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="search-keyword" placeholder="æœç´¢é—œéµè©...">
                        </div>
                        <div class="mb-3">
                            <select class="form-select" id="search-category">
                                <option value="">æ‰€æœ‰é¡åˆ¥</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ—¥æœŸç¯„åœ</label>
                            <input type="date" class="form-control mb-2" id="search-start-date">
                            <input type="date" class="form-control" id="search-end-date">
                        </div>
                        <button class="btn btn-success w-100" id="search-button">æœç´¢</button>
                    </div>
                </div>
            </div>
            
            <!-- ä¸­é–“ï¼šå°è©±åˆ—è¡¨ -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <span id="conversation-list-title">å°è©±åˆ—è¡¨</span>
                        <span class="badge bg-light text-dark" id="conversation-count">0</span>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush conversation-list" id="conversation-list">
                            <li class="list-group-item text-center">è«‹é¸æ“‡ä¸€å€‹å°ˆæ¡ˆæˆ–é€²è¡Œæœç´¢</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- å³å´ï¼šå°è©±å…§å®¹ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <span id="conversation-title">å°è©±è©³æƒ…</span>
                            <span class="badge bg-primary" id="conversation-date"></span>
                        </div>
                    </div>
                    <div class="card-body conversation-detail" id="conversation-detail">
                        <div class="no-conversation-selected">
                            <h5>è«‹é¸æ“‡ä¸€å€‹å°è©±ä»¥æŸ¥çœ‹è©³æƒ…</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.2.4/marked.min.js"></script>
    <script>
        // API URL
        // const API_BASE_URL = 'http://localhost:3001/api';
        const API_BASE_URL = `${window.location.protocol}//${window.location.host}/api`;
        // const getHostUrl = () => {
        // // å¾ç’°å¢ƒè®Šé‡ç²å–ï¼Œæˆ–ä½¿ç”¨é»˜èªå€¼
        // const host = process.env.HOST || 'localhost';
        // const port = process.env.PORT || '3001';
        // return `http://${host}:${port}/api`;
        // };

        // DOMå…ƒç´ 
        const projectList = document.getElementById('project-list');
        const conversationList = document.getElementById('conversation-list');
        const conversationListTitle = document.getElementById('conversation-list-title');
        const conversationCount = document.getElementById('conversation-count');
        const conversationTitle = document.getElementById('conversation-title');
        const conversationDate = document.getElementById('conversation-date');
        const conversationDetail = document.getElementById('conversation-detail');
        const searchKeyword = document.getElementById('search-keyword');
        const searchCategory = document.getElementById('search-category');
        const searchStartDate = document.getElementById('search-start-date');
        const searchEndDate = document.getElementById('search-end-date');
        const searchButton = document.getElementById('search-button');
        
        // è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨
        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE_URL}/projects`);
                const projects = await response.json();
                
                if (projects.length === 0) {
                    projectList.innerHTML = '<li class="list-group-item text-center">æ²’æœ‰å°ˆæ¡ˆ</li>';
                    return;
                }
                
                projectList.innerHTML = projects.map(project => `
                    <li class="list-group-item project-item" data-project-id="${project.ProjectID}">
                        ${project.ProjectName}
                    </li>
                `).join('');
                
                // æ·»åŠ é»æ“Šäº‹ä»¶
                document.querySelectorAll('.project-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const projectId = this.getAttribute('data-project-id');
                        loadConversations(projectId);
                        
                        // æ›´æ–°æ´»å‹•ç‹€æ…‹
                        document.querySelectorAll('.project-item').forEach(p => p.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
            } catch (error) {
                console.error('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—:', error);
                projectList.innerHTML = '<li class="list-group-item text-center text-danger">è¼‰å…¥å¤±æ•—</li>';
            }
        }
        
        // è¼‰å…¥å°è©±åˆ—è¡¨
        async function loadConversations(projectId) {
            try {
                conversationList.innerHTML = '<li class="list-group-item text-center">è¼‰å…¥ä¸­...</li>';
                
                const response = await fetch(`${API_BASE_URL}/conversations/${projectId}`);
                const conversations = await response.json();
                
                if (conversations.length === 0) {
                    conversationList.innerHTML = '<li class="list-group-item text-center">æ²’æœ‰å°è©±</li>';
                    conversationCount.textContent = '0';
                    return;
                }
                
                conversationListTitle.textContent = 'å°ˆæ¡ˆå°è©±';
                conversationCount.textContent = conversations.length;
                
                conversationList.innerHTML = conversations.map(conv => {
                    const statusMap = {
                        resolved: { text: 'âœ… å·²è§£æ±º', class: 'bg-success text-white' },
                        pending: { text: 'ğŸ•“ å¾…è™•ç†', class: 'bg-danger text-white' },
                        other: { text: 'ğŸ“Œ å…¶ä»–', class: 'bg-warning text-dark' }
                    };

                    const { text: statusText, class: badgeClass } = conv.StatusTag && statusMap[conv.StatusTag]
                        ? statusMap[conv.StatusTag]
                        : { text: 'â“ æœªæ¨™è¨˜', class: 'bg-secondary text-white' };

                    return `
                        <li class="list-group-item conversation-item" data-conversation-id="${conv.ConversationID}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${conv.Title || 'ç„¡æ¨™é¡Œ'}</div>
                                    <small class="text-muted">${formatDate(new Date(conv.CreatedDate))}</small>
                                </div>
                                <span class="badge bg-secondary badge-category">${conv.Category || 'æœªåˆ†é¡'}</span>
                            </div>
                            <div class="small text-truncate mt-1">${conv.Summary || 'ç„¡æ‘˜è¦'}</div>
                            <span class="badge ${badgeClass}"><i class="bi bi-tag-fill"></i> ç‹€æ…‹ï¼š${statusText}</span>
                        </li>
                    `;
                }).join('');

                
                // æ·»åŠ é»æ“Šäº‹ä»¶
                addConversationClickListeners();
            } catch (error) {
                console.error('è¼‰å…¥å°è©±å¤±æ•—:', error);
                conversationList.innerHTML = '<li class="list-group-item text-center text-danger">è¼‰å…¥å¤±æ•—</li>';
            }
        }
        
        // è¼‰å…¥å–®å€‹å°è©±è©³æƒ…
        async function loadConversationDetail(conversationId) {
            try {
                conversationDetail.innerHTML = '<div class="text-center my-5"><div class="spinner-border" role="status"></div><div class="mt-2">è¼‰å…¥ä¸­...</div></div>';
                
                const response = await fetch(`${API_BASE_URL}/conversation/${conversationId}`);
                const conversation = await response.json();
                
                conversationTitle.textContent = conversation.Title || 'ç„¡æ¨™é¡Œå°è©±';
                conversationDate.textContent = formatDate(new Date(conversation.CreatedDate));
                
                // è§£æå¸¶æœ‰æ®µè½æ¨™è¨˜çš„æ¶ˆæ¯
                const userMessages = parseMessagesByParagraphMarker(conversation.UserQuery);
                const aiMessages = parseMessagesByParagraphMarker(conversation.AIResponse);
                
                // å‰µå»ºæ®µè½æ˜ å°„ï¼Œå°‡æ®µè½ç·¨è™Ÿæ˜ å°„åˆ°æ¶ˆæ¯å…§å®¹
                const paragraphMap = new Map();
                
                // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯åˆ°æ˜ å°„
                userMessages.forEach(msg => {
                    if (!paragraphMap.has(msg.paragraphNumber)) {
                        paragraphMap.set(msg.paragraphNumber, {});
                    }
                    paragraphMap.get(msg.paragraphNumber).user = msg.content;
                });
                
                // æ·»åŠ  AI æ¶ˆæ¯åˆ°æ˜ å°„
                aiMessages.forEach(msg => {
                    if (!paragraphMap.has(msg.paragraphNumber)) {
                        paragraphMap.set(msg.paragraphNumber, {});
                    }
                    paragraphMap.get(msg.paragraphNumber).ai = msg.content;
                });
                
                // æŒ‰æ®µè½ç·¨è™Ÿæ’åº
                const sortedParagraphs = [...paragraphMap.entries()].sort((a, b) => a[0] - b[0]);
                const statusMap = {
                    resolved: 'âœ… å·²è§£æ±º',
                    pending: 'ğŸ•“ å¾…è™•ç†',
                    other: 'ğŸ“Œ å…¶ä»–'
                };

                const statusText = conversation.StatusTag ? statusMap[conversation.StatusTag] || conversation.StatusTag : 'â“ æœªæ¨™è¨˜';

                // é–‹å§‹æ§‹å»ºå°è©±å…§å®¹
                let detailHTML = `
                    <div class="mb-3">
                        <h5 class="badge bg-secondary">${conversation.Category || 'æœªåˆ†é¡'}</h5>
                        <p class="fst-italic">${conversation.Summary || 'ç„¡æ‘˜è¦'}</p>
                    </div>
                    <div class="conversation-flow" id="conversation-messages">
                `;
                detailHTML = `
                <div class="mb-2">
                    <span class="badge bg-warning text-dark"><i class="bi bi-tag-fill"></i> ç‹€æ…‹ï¼š${statusText}</span>
                </div>
                ` + detailHTML;
                // å¦‚æœæ²’æœ‰æ‰¾åˆ°æ®µè½æ¨™è¨˜ï¼Œé¡¯ç¤ºå‚™ç”¨è¦–åœ–
                if (sortedParagraphs.length === 0) {
                    detailHTML += `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            é€™å€‹å°è©±æ²’æœ‰æ®µè½æ¨™è¨˜ã€‚å¯èƒ½æ˜¯åœ¨æ®µè½æ¨™è¨˜åŠŸèƒ½æ·»åŠ ä¹‹å‰ä¿å­˜çš„å°è©±ã€‚
                        </div>
                        <div class="user-query">
                            <div class="message-header">
                                <div>
                                    <span class="user-icon">U</span>
                                    <span class="fw-bold">ä½¿ç”¨è€…</span>
                                </div>
                            </div>
                            <div class="message-content">${marked.parse(conversation.UserQuery)}</div>
                        </div>
                        <div class="ai-response">
                            <div class="message-header">
                                <div>
                                    <span class="ai-icon">AI</span>
                                    <span class="fw-bold">AIåŠ©æ‰‹</span>
                                </div>
                            </div>
                            <div class="message-content">${marked.parse(conversation.AIResponse)}</div>
                        </div>
                    `;
                } else {
                    // éæ­·æ’åºå¾Œçš„æ®µè½
                    sortedParagraphs.forEach(([number, messages]) => {
                        // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯
                        if (messages.user) {
                            const parsedUserMessage = marked.parse(messages.user);
                            detailHTML += `
                                <div class="user-query">
                                    <div class="message-header">
                                        <div>
                                            <span class="user-icon">U</span>
                                            <span class="fw-bold">ä½¿ç”¨è€…</span>
                                        </div>
                                        <span class="message-number">#${number}</span>
                                    </div>
                                    <div class="message-content">${parsedUserMessage}</div>
                                    <div class="message-reactions">
                                        <button class="reaction-button copy-btn" data-message-type="user" data-message-number="${number}">
                                            <i class="bi bi-clipboard"></i> è¤‡è£½
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // æ·»åŠ  AI æ¶ˆæ¯
                        if (messages.ai) {
                            const parsedAIMessage = marked.parse(messages.ai);
                            detailHTML += `
                                <div class="ai-response">
                                    <div class="message-header">
                                        <div>
                                            <span class="ai-icon">AI</span>
                                            <span class="fw-bold">AIåŠ©æ‰‹</span>
                                        </div>
                                        <span class="message-number">#${number}</span>
                                    </div>
                                    <div class="message-content">${parsedAIMessage}</div>
                                    <div class="message-reactions">
                                        <button class="reaction-button copy-btn" data-message-type="ai" data-message-number="${number}">
                                            <i class="bi bi-clipboard"></i> è¤‡è£½
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                }
                
                detailHTML += '</div>'; // é—œé–‰ conversation-messages div
                
                // å¦‚æœæœ‰ä»£ç¢¼ç‰‡æ®µï¼Œé¡¯ç¤ºå®ƒå€‘
                if (conversation.snippets && conversation.snippets.length > 0) {
                    detailHTML += `
                        <div class="mt-4 pt-3 border-top">
                            <h5 class="mb-3">
                                <i class="bi bi-code-square"></i> 
                                ä»£ç¢¼ç‰‡æ®µ <span class="badge bg-secondary">${conversation.snippets.length}</span>
                            </h5>
                            <div class="accordion" id="codeSnippetsAccordion">
                    `;
                    
                    conversation.snippets.forEach((snippet, index) => {
                        detailHTML += `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading${index}">
                                    <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#collapse${index}" 
                                            aria-expanded="${index === 0}" aria-controls="collapse${index}">
                                        ç‰‡æ®µ ${index + 1} - ${snippet.Language || 'ç„¡èªè¨€'}
                                    </button>
                                </h2>
                                <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                                     aria-labelledby="heading${index}" data-bs-parent="#codeSnippetsAccordion">
                                    <div class="accordion-body p-0">
                                        <div class="d-flex justify-content-end p-2 border-bottom">
                                            <button class="btn btn-sm btn-outline-secondary copy-code-btn" 
                                                    data-snippet-index="${index}">
                                                <i class="bi bi-clipboard"></i> è¤‡è£½ä»£ç¢¼
                                            </button>
                                        </div>
                                        <pre class="m-0"><code class="${snippet.Language}">${escapeHtml(snippet.Code)}</code></pre>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    detailHTML += `
                            </div>
                        </div>
                    `;
                }
                
                conversationDetail.innerHTML = detailHTML;
                
                // æ‡‰ç”¨ç¨‹å¼ç¢¼é«˜äº®
                document.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
                
                // æ·»åŠ è¤‡è£½æŒ‰éˆ•åŠŸèƒ½
                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const type = this.getAttribute('data-message-type');
                        const number = parseInt(this.getAttribute('data-message-number'));
                        
                        let textToCopy = '';
                        if (type === 'user' && paragraphMap.has(number)) {
                            textToCopy = paragraphMap.get(number).user;
                        } else if (type === 'ai' && paragraphMap.has(number)) {
                            textToCopy = paragraphMap.get(number).ai;
                        }
                        
                        if (textToCopy) {
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                // æ›´æ”¹æŒ‰éˆ•æ–‡æœ¬ç‚ºå·²è¤‡è£½
                                const originalText = this.innerHTML;
                                this.innerHTML = '<i class="bi bi-check2"></i> å·²è¤‡è£½';
                                
                                // 2ç§’å¾Œæ¢å¾©
                                setTimeout(() => {
                                    this.innerHTML = originalText;
                                }, 2000);
                            });
                        }
                    });
                });
                
                // æ·»åŠ ä»£ç¢¼è¤‡è£½æŒ‰éˆ•åŠŸèƒ½
                document.querySelectorAll('.copy-code-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-snippet-index'));
                        const code = conversation.snippets[index].Code;
                        
                        navigator.clipboard.writeText(code).then(() => {
                            // æ›´æ”¹æŒ‰éˆ•æ–‡æœ¬ç‚ºå·²è¤‡è£½
                            const originalText = this.innerHTML;
                            this.innerHTML = '<i class="bi bi-check2"></i> å·²è¤‡è£½';
                            
                            // 2ç§’å¾Œæ¢å¾©
                            setTimeout(() => {
                                this.innerHTML = originalText;
                            }, 2000);
                        });
                    });
                });
            } catch (error) {
                console.error('è¼‰å…¥å°è©±è©³æƒ…å¤±æ•—:', error);
                conversationDetail.innerHTML = '<div class="alert alert-danger">è¼‰å…¥å°è©±è©³æƒ…å¤±æ•—</div>';
            }
        }
        
        // åŸ·è¡Œæœç´¢
        async function performSearch() {
            const keyword = searchKeyword.value.trim();
            const category = searchCategory.value;
            const startDate = searchStartDate.value;
            const endDate = searchEndDate.value;
            
            // æ§‹å»ºæŸ¥è©¢åƒæ•¸
            const params = new URLSearchParams();
            if (keyword) params.append('keyword', keyword);
            if (category) params.append('category', category);
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            
            try {
                conversationList.innerHTML = '<li class="list-group-item text-center">æœç´¢ä¸­...</li>';
                
                const response = await fetch(`${API_BASE_URL}/search?${params.toString()}`);
                const results = await response.json();
                
                if (results.length === 0) {
                    conversationList.innerHTML = '<li class="list-group-item text-center">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„çµæœ</li>';
                    conversationCount.textContent = '0';
                    return;
                }
                
                conversationListTitle.textContent = 'æœç´¢çµæœ';

                conversationCount.textContent = results.length;
                const statusMap = {
                    resolved: { text: 'âœ… å·²è§£æ±º', class: 'bg-success text-white' },
                    pending: { text: 'ğŸ•“ å¾…è™•ç†', class: 'bg-danger text-white' },
                    other: { text: 'ğŸ“Œ å…¶ä»–', class: 'bg-warning text-dark' }
                };


                conversationList.innerHTML = results.map(conv => {
                    const { text: statusText, class: badgeClass } = conv.StatusTag && statusMap[conv.StatusTag]
                    ? statusMap[conv.StatusTag]
                    : { text: 'â“ æœªæ¨™è¨˜', class: 'bg-secondary text-white' };
                                    
                    return `
                        <li class="list-group-item conversation-item" data-conversation-id="${conv.ConversationID}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${conv.Title || 'ç„¡æ¨™é¡Œ'}</div>
                                    <small class="text-muted">${formatDate(new Date(conv.CreatedDate))}</small>
                                </div>
                                <span class="badge bg-secondary badge-category">${conv.Category || 'æœªåˆ†é¡'}</span>
                            </div>
                            <div class="small text-truncate mt-1">${conv.Summary || 'ç„¡æ‘˜è¦'}</div>
                            <span class="badge ${badgeClass}"><i class="bi bi-tag-fill"></i> ç‹€æ…‹ï¼š${statusText}</span><br/>
                            <small class="text-muted">å°ˆæ¡ˆ: ${conv.ProjectName}</small>
                        </li>
                    `;
                }).join('');
                
                // æ·»åŠ é»æ“Šäº‹ä»¶
                addConversationClickListeners();
            } catch (error) {
                console.error('æœç´¢å¤±æ•—:', error);
                conversationList.innerHTML = '<li class="list-group-item text-center text-danger">æœç´¢å¤±æ•—</li>';
            }
        }
        
        // è¼‰å…¥æ‰€æœ‰é¡åˆ¥
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/categories`);
                const categories = await response.json();
                
                let optionsHTML = '<option value="">æ‰€æœ‰é¡åˆ¥</option>';
                categories.forEach(category => {
                    optionsHTML += `<option value="${category}">${category}</option>`;
                });
                
                searchCategory.innerHTML = optionsHTML;
            } catch (error) {
                console.error('è¼‰å…¥é¡åˆ¥å¤±æ•—:', error);
            }
        }
        
        // æ·»åŠ å°è©±é»æ“Šäº‹ä»¶ç›£è½å™¨
        function addConversationClickListeners() {
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', function() {
                    const conversationId = this.getAttribute('data-conversation-id');
                    loadConversationDetail(conversationId);
                    
                    // æ›´æ–°æ´»å‹•ç‹€æ…‹
                    document.querySelectorAll('.conversation-item').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        // è§£æå¸¶æœ‰æ®µè½æ¨™è¨˜çš„æ¶ˆæ¯
        // å¼·åŒ–æ®µè½æ¨™è¨˜è§£æå‡½æ•¸ï¼Œè™•ç†å¯èƒ½çš„ç‰¹æ®Šæƒ…æ³
        function parseMessagesByParagraphMarker(text) {
            if (!text) return [];
            
            console.log('è§£ææ–‡æœ¬é•·åº¦:', text.length);
            console.log('æ–‡æœ¬å‰30å€‹å­—ç¬¦:', text.substring(0, 30));
            
            // æ¸…ç†å¯èƒ½å½±éŸ¿è§£æçš„ç‰¹æ®Šæ¨™è¨˜
            let cleanedText = text
                .replace(/(\w+)è¤‡è£½ç·¨è¼¯/g, '') // ç§»é™¤é¡ä¼¼ "bashè¤‡è£½ç·¨è¼¯" çš„æ¨™è¨˜
                .replace(/è¤‡è£½ç·¨è¼¯/g, '');     // ç§»é™¤å–®ç¨çš„ "è¤‡è£½ç·¨è¼¯" æ¨™è¨˜
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ®µè½æ¨™è¨˜
            const hasMarkers = /\[å°è©±æ®µè½:\d+\]/g.test(cleanedText);
            console.log('æ˜¯å¦æ‰¾åˆ°æ®µè½æ¨™è¨˜:', hasMarkers);
            
            if (!hasMarkers) {
                console.log('æœªæ‰¾åˆ°æ®µè½æ¨™è¨˜ï¼Œè¿”å›æ•´å€‹æ–‡æœ¬ä½œç‚ºä¸€å€‹æ®µè½');
                return [{
                    paragraphNumber: 1,
                    content: text.trim()
                }];
            }
            
            // ä½¿ç”¨æ®µè½æ¨™è¨˜ä½œç‚ºåˆ†éš”ç¬¦
            const regex = /\[å°è©±æ®µè½:(\d+)\]\n?([\s\S]*?)(?=\[å°è©±æ®µè½:\d+\]|$)/g;
            let matches = [...cleanedText.matchAll(regex)];
            
            console.log('æ‰¾åˆ°çš„æ®µè½æ•¸é‡:', matches.length);
            
            // å¦‚æœæ²’æœ‰åŒ¹é…åˆ°ä»»ä½•æ®µè½ï¼Œä»ç„¶è¿”å›æ•´å€‹æ–‡æœ¬
            if (matches.length === 0) {
                console.log('æ­£å‰‡è¡¨é”å¼æœªåŒ¹é…åˆ°æ®µè½ï¼Œè¿”å›æ•´å€‹æ–‡æœ¬');
                return [{
                    paragraphNumber: 1,
                    content: text.trim()
                }];
            }
            
            // å°‡åŒ¹é…çµæœè½‰æ›ç‚ºå°è±¡æ•¸çµ„ï¼ŒåŒ…å«æ®µè½ç·¨è™Ÿå’Œå…§å®¹
            const result = matches.map(match => ({
                paragraphNumber: parseInt(match[1]),
                content: match[2].trim()
            }));
            
            console.log('è§£æçµæœ:', result.map(r => `æ®µè½ ${r.paragraphNumber}: ${r.content.substring(0, 20)}...`));
            
            return result;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            // å°ç£æ˜¯ UTC+8
            const offsetMs = 8 * 60 * 60 * 1000;
            const taiwanDate = new Date(date.getTime());
            console.log(taiwanDate.getUTCHours());
            return `${taiwanDate.getUTCFullYear()}-${(taiwanDate.getUTCMonth() + 1).toString().padStart(2, '0')}-${taiwanDate.getUTCDate().toString().padStart(2, '0')} ${taiwanDate.getUTCHours().toString().padStart(2, '0')}:${taiwanDate.getUTCMinutes().toString().padStart(2, '0')}`;
        }
        
        // HTMLè½‰ç¾©
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            loadCategories();
            
            // ç¶å®šæœç´¢æŒ‰éˆ•é»æ“Šäº‹ä»¶
            searchButton.addEventListener('click', performSearch);
            
            // æ”¯æŒæŒ‰Enteréµæœç´¢
            searchKeyword.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    performSearch();
                }
            });

            const startInput = document.getElementById("search-start-date");
            const endInput = document.getElementById("search-end-date");

            const today = new Date();
            // è¨ˆç®—é€±ä¸€ï¼ˆ0=Sunday, 1=Monday, ..., 6=Saturdayï¼‰
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // è‹¥æ˜¯é€±æ—¥ï¼Œå›æ¨6å¤©ï¼›å¦å‰‡å›æ¨åˆ°é€±ä¸€
            const monday = new Date(today);
            monday.setDate(today.getDate() + mondayOffset);

            // æ ¼å¼åŒ– yyyy-mm-dd
            const formatDate = (d) => d.toISOString().split('T')[0];
            const sunday = new Date(today);
            sunday.setDate(monday.getDate() + 6);

            startInput.value = formatDate(monday);
            
            endInput.value = formatDate(sunday);
        });
    </script>
</body>
</html>
